000100200709      *========================================================================
000101200709     h option(*nodebugio)
000102200709      *========================================================================
000103200709      * RPA61BR - Parse CSV to Fields, initial edit
000104200709      *========================================================================
000105200709      * Date         Int  Description
000106200709      * ---------    ---  -----------------------------------------------------
000107200709      * 10/24/2019   jt   Original Creation (re-wote)
000108200727      * 08/11/2019   jt   Subtracted 1 month to current month
000109200910      * 09/10/2020   jt   Recomplied for DB change.
000110200709      *========================================================================
000111200709
001300200709     frpa61wfa  if   e             disk    rename(rpa61wfar:mainFile)
001400200709
001401200709     frpa60wf   uf a e             disk    rename(r60f:csvWFile)
001402200709     f
001403200709     frpa60wfb  uf a e             disk    rename(r60f:errorFile)
001404200709
001405200709     fsmanrlt   if   e           k disk    extfile('F.SMANRLT')
001406200709
001407200709     fgratel1   if   e           k disk    rename(grater:grat1)
001408200709     f                                     extfile('F.GRATEL1')
001409200709
001410200727     fgratel2   if   e           k disk    rename(grater:grat2)
001411200709     f                                     extfile('F.GRATEL2')
001412200709
001413200709     FRPA060L2  IF   E           K DISK
001700130109     FTRMUNIQUE IF   E           K DISK
001800130109     FSUMUNIQUE IF   E           K DISK
001900130109     FACMUNIQUE IF   E           K DISK
002200130109     FPLNUNIQUE IF   E           K DISK
002301200709     F*T2000     O  A F 2000        DISK
002400200709
002401200709      *========================================================================
002801200709
002900130110     D @OUT            S           2000A
004500200709
007701200709     d @emsg           s             40
008400200709     d mitch#mth       s              2
008901200709     d dateHold        s               d
008902200709     d msg@prt         s            800
008903200709     d pos             s              2  0
008904200709     d #errorsd        s              5  0
008905200709
011201200709     d rpa61br         pi
011203200709     d  #errors                       5
011204200709
011301200709      //======================================================================
011302200709      // mainline
011303200709      //======================================================================
011304200709
011305200709       exsr init;
011306200709       exsr main;
011307200709       exsr exit;
011309200709
011310200709      //======================================================================
011311200709      // main
011312200709      //======================================================================
011313200709
011314200709       begsr main;
011315200709
011316200709        setll 1 mainFile;
011317200709        read mainfile;
011318200709
011319200709        dow not %eof;
011320200709
011322200709         exsr process;
011323200709
011324200709         if msg@prt > ' ';
011325200709          clear errorFile;
011326200709           exsr writeFile;
011327200709            r6note2 = msg@prt;
011328200727            exsr writeError;
011329200709           write errorFile;
011330200709          msg@prt = ' ';
011331200709         endif;
011332200709
011333200709        read mainfile;
011334200709        enddo;
011335200709
011336200709        #errors = %editc(%dec(#errorsd:5:0):'X');
011337200709
011338200709       endsr;
014601200709
026901200709      //======================================================================
026902200709      // process
026903200709      //======================================================================
026904200709
026905200709       begsr process;
026906200709
026907200727        exsr move_toKeyL;
026908200709     C     KEY#RPA       CHAIN     RPA60R
026909200709        if %found;
026910200709         @emsg = 'RECORD ALREADY EXISTS, ADD DENIED';
026911200709         exsr eMsg;
026912200709        endif;
026913200709
026914200709        monitor;
027200200709         dateHold = %date(%dec(crdate:8:0));
027201200709        on-error;
027202200709         @emsg = 'COMM REMIT DATE NOT VALID';
027203200709         exsr eMsg;
027204200709        endmon;
028300200709
028301200709        if seq# = '00' or seq# = ' 0' or seq# = '0 ' or seq# = ' ';
028800200709         @emsg = 'SEQ # NOT VALID';
028900200709         exsr eMsg;
029200200709        endif;
029300200709
030400200709        if cpdate > '00000000';
030401200709         if %subst(cpdate:5:2) <> mitch#mth;
030700200709          @emsg = 'COMM PAID DATE NOT CURRENT OR ZERO';
030701200709          exsr eMsg;
030702200709         endif;
030703200709        endif;
031100200709
031800200709        chain relid srf;
031900200709        if not %found;
032000200709         @emsg = 'INVALID RELID';
032100200709         exsr eMsg;
032200200709        endif;
032201200709
033300200709        chain (%dec(trust:3:0)) trsmsr;
033400200709        if not %found;
033401200709         @emsg = 'TRUST NOT VALID';
033402200709         exsr eMsg;
034000200709        endif;
034001200709
035100200709        chain (%dec(trust:3:0) : %dec(sub:3:0)) submsr;
035200200709        if not %found;
035300200709         @emsg = 'SUBDVSN NOT VALID';
035400200709         exsr emsg;
035700200709        endif;
035701200709
035702200709        chain (%dec(trust:3:0) : %dec(sub:3:0): %dec(acct:4:0)) accmsr;
037100200709        if not %found;
037200200709         @emsg = 'ACCOUNT NOT VALID';
037300200709         exsr emsg;
037400200709        endif;
037800200709
038400200709        chain group# grat1;
038500200709        if not %found;
038600200709         @emsg = 'INVALID GROUP';
038700200709         exsr emsg;
038701200709        endif;
038702200709
038703200709        chain (%dec(trust:3:0) : %dec(sub:3:0) : plan#) plnmsr;
040000200709        if not %found;
040100200709         @emsg = 'PLAN NOT VALID';
040200200709         exsr emsg;
040201200709        endif;
040300200709
040500200709        chain (group# : %dec(trust:3:0) : %dec(sub:3:0) : plan#) grat2;
040600200709        if not %found;
040700200709         @emsg = 'INVALID GROUP';
040800200709         exsr eMsg;
040900200709        endif;
040901200709
040902200709        monitor;
040903200709         dateHold = %date(%dec(effdate:8:0));
040904200709        on-error;
040905200709         @emsg = 'EFF DATE NOT VALID';
040906200709         exsr eMsg;
040907200709        endmon;
040908200709
044200200709        if method <> 'G' and method <> 'C' and method <> 'F'
044300200709         and method <> 'O' and method <> 'P';
044500200709          @emsg = 'METHOD IS INVALID';
044501200709         exsr eMSg;
044700200709        endif;
044800200709
045400200709        if paidfl <> 'Y' and paidfl <> 'N';
045700200709         @emsg = 'COMM PAID FLAG IS INVALID';
045800200709         exsr eMsg;
045900200709        endif;
045901200709
046600200709        if (method = 'O' or method = 'P') and paidfl = 'Y' and premium = 0;
046900200709         @emsg = 'MISSING PREMIUM';
047000200709         exsr eMsg;
047100200709        endif;
047101200709
047200200709        if paidfl = 'N' and (premium <> 0 or lives <> 0);
047400200709         @emsg = 'PREM/COUNT SHOULD BE ZERO';
047500200709         exsr eMsg;
047600200709        endif;
048000200709
048201200709        if msg@prt = ' ';
048202200709         clear csvWFile;
048203200709          exsr writeFile;
048228200709         write csvWFile;
048230200709        endif;
048231200709
048300200709       endsr;
048301200709
048302200727      //======================================================================
048303200727      // write error
048304200727      //======================================================================
048305200727
048306200727       begsr move_toKeyL;
048307200727
048308200727         r6cpddt = 0;
048309200727         if cpdate > '00000000';
048310200727          r6cpddt = %dec(cpdate:8:0);
048311200727         endif;
048312200727
048313200727         r6cdat = 0;
048314200727         if crdate > '00000000';
048315200727          r6cdat = %dec(crdate:8:0);
048316200727         endif;
048317200727
048318200727         r6seq = 0;
048319200727         if seq# > '00';
048320200727          r6seq = %dec(seq#:2:0);
048321200727         endif;
048322200727
048323200727         r6relid = relid;
048324200727         r6trs = %dec(trust:3:0);
048325200727         r6sub = %dec(sub:3:0);
048326200727         r6acc = %dec(acct:4:0);
048327200727         r6grp = group#;
048328200727         r6pln = plan#;
048329200727
048330200727         r6efdt = 0;
048331200727         if effdate > '00000000';
048332200727          r6efdt = %dec(effdate:8:0);
048333200727         endif;
048334200727
048335200727       endsr;
048336200727
048337200709      //======================================================================
048338200709      // write error
048339200709      //======================================================================
048340200709
048341200709       begsr writeError;
048342200709
048343200709        if msg@prt > ' ';
048344200709         r6cdat = %dec(crdate:8:0);
048345200709         r6seq = %dec(seq#:2:0);
048346200709
048347200709         r6cpddt = 0;
048348200709         if cpdate > '00000000';
048349200709          r6cpddt = %dec(cpdate:8:0);
048350200709         endif;
048351200709
048352200709         r6relid = relid;
048353200709         r6trs = %dec(trust:3:0);
048354200709         r6sub = %dec(sub:3:0);
048355200709         r6acc = %dec(acct:4:0);
048356200709         r6grp = group#;
048357200709         r6pln = plan#;
048358200709         r6efdt = %dec(effdate:8:0);
048359200709         r6pprm = premium;
048360200709         r6mcnt = lives;
048361200709         r6cmrt = commrt;
048362200709         r6mthd = method;
048363200709         r6pspl = splitr;
048364200709         r6paid = paidfl;
048365200709         r6note = note;
048366200709         r6note2 = msg@prt;
048367200709
048368200709        endif;
048369200709
048370200709       endsr;
048371200709
048372200709      //======================================================================
048373200709      // error msg
048374200709      //======================================================================
048375200709
048376200709       begsr eMsg;
048377200709
048700200709        #errorsd = #errorsd + 1;
048800200709        pos = %scan('ERROR:' : msg@prt : 1);
048802200709        if pos = 1;
048803200709         msg@prt = %trim(msg@prt) + ';' + %trim(@emsg);
048805200709        else;
048807200709         msg@prt = 'ERROR:' + %trim(@emsg);
048808200709        endif;
049500200709
049600200709        @emsg = ' ';
049705200709
049800200709       endsr;
049801200709
049802200709      //======================================================================
049803200709      // write error
049804200709      //======================================================================
049805200709
049806200709       begsr writeFile;
049807200709
049809200727        if msg@prt = ' ';
049810200709         r6cdat = %dec(crdate:8:0);
049811200709         r6seq = %dec(seq#:2:0);
049812200709
049813200709         r6cpddt = 0;
049814200709         if cpdate > '00000000';
049815200709          r6cpddt = %dec(cpdate:8:0);
049816200709         endif;
049817200709
049818200709         r6relid = relid;
049819200709         r6trs = %dec(trust:3:0);
049820200709         r6sub = %dec(sub:3:0);
049821200709         r6acc = %dec(acct:4:0);
049822200709         r6grp = group#;
049823200709         r6pln = plan#;
049824200709         r6efdt = %dec(effdate:8:0);
049825200709         r6pprm = premium;
049826200709         r6mcnt = lives;
049827200709         r6cmrt = commrt;
049828200709         r6mthd = method;
049829200709         r6pspl = splitr;
049830200709         r6paid = paidfl;
049831200709         r6note = note;
049834200709        endif;
049835200709
049836200709       endsr;
049837200709
049838200709      //======================================================================
049839200709      // exit
049840200709      //======================================================================
049841200709
049842200709       begsr exit;
049843200709
049844200709        *inlr = '1';
049845200709        return;
049846200709
049847200709       endsr;
049848200709
049849200709      //======================================================================
049850200709      // init
049851200709      //======================================================================
049852200709
049853200709       begsr init;
049854200709
049855200709     C     KEY#RPA       KLIST
049856200709     C                   KFLD                    R6CPDDT
049857200709     C                   KFLD                    R6CDAT
049858200709     C                   KFLD                    R6SEQ
049859200709     C                   KFLD                    R6RELID
049860200709     C                   KFLD                    R6TRS
049861200709     C                   KFLD                    R6SUB
049862200709     C                   KFLD                    R6ACC
049863200709     C                   KFLD                    R6GRP
049864200709     C                   KFLD                    R6PLN
049865200709     C                   KFLD                    R6EFDT
049866200709
049868200727        mitch#mth = %editc(%dec(%char(%subdt(%date() - %months(1)
049870200727                    :*months)):2:0):'X');
049871200709     C****               EVAL      @OUT = '"COMM REMIT DATE","SEQ NBR","COMM ' +
049872200709     C****                         'PAID DATE","RELID","TRUST","SUB","ACCT","' +
049873200709     C****                         'GROUP #","PLAN ID","EFFECTIVE DATE","PLAN' +
049874200709     C****                         ' PREM","MBR CNT","COMM RATE","METHOD","PR' +
049875200709     C****                         'EM SPLIT","PAID","NOTE","ERROR"'
049876200709     C****               EXCEPT    OUTF
049877200709
049878200709       endsr;
049879200709
049880200709      //======================================================================
049881200709
069700200709     O*T2000     EADD         OUTF
069800200709     O*                       @OUT           B  2000
