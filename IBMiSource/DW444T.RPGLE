0001000204020002  *****************************************************************************
000200101012      * DW444T     Group Benefit Services                                         *
000300020402      *            WRITTEN BY - R.L.J.                                            *
000400101011      *            DATE - 10/2010                                                 *
000500091001      *  DESCRIPTION - Create MBI update files using GBS MBI Chg file             *
000600091230      * NOTE!! When you make a chg to MBxxP files - change D-specs here           *
0007000204020002  *****************************************************************************
0008000204020015  *  Change Log:                                                              *
000900020402      *                                                                *
0010009102150018 F******************************************************************
0011001004220020 FMBCHG2P   IF   E           K DISK
0012001004220020 FMBCUR2P   IF   E           K DISK
0013000910010020 FMBIAP     UF   E             DISK
0014001010120020 F**MBIBP     O    E             DISK
0015000910010020 FMBICP     O    E             DISK
0016001010120020 F**MBIFP     O    E             DISK
0017001010120020 F**MBIZP     O    E             DISK
0018000910080020 FMBCMBP    O    E             DISK
0019001010280025  *
0020001010280250 D                 DS
0021001010280251 D  today                          D   DATFMT(*ISO)
0022001010280251 D  todayn                        8S 0
0023000707230025  *
0024000204030250 D                 DS
0025000910020251 D  mcarea                 1      3  0
0026000910020251 D   areac                 1      3
0027000910020025  *
0028000910020250 D                 DS
0029000910020251 D  mxcgrp#                1     15
0030000910020251 D   cgrp4                 1      4
0031000910020025  *
0032000910020250 D                 DS
0033000910020251 D  mcgrp#                 1     15
0034000910020251 D   grp4                  1      4
0035001004210251 D   grp1                  1      1
0036001004210251 D   grp24                 2      4
0037000912030251 D   grp12                 1     12
0038001005240251 D   grp212                2     12
0039000912030251 D   grp13                13     15
0040001003260025  *
0041001003260250 D                 DS
0042001003260251 D  mbgrp#                 1      9
0043001003260251 D   bgrp1                 1      3    INZ('GBS')
0044001003260251 D   bgrp2                 4      7
0045000805150029  *
0046000805150250 D                 DS
0047000910010251 D  mcphn#                 1      7  0
0048000910010251 D   p3                    1      3
0049000910010251 D   p4                    4      7
0050000910010029  *
0051000910010250 D                 DS
0052000910010251 D  curkey                 1     11  0
0053000910010251 D   mcmid#                1      9  0
0054000910010251 D   mcmida                1      9
0055000809180251 D   mcseq#               10     11  0
0056000505250029  *
0057000510120250 D                 DS
0058000505250251 D  chgkey                 1     11  0
0059000809190251 D   mxmid#                1      9  0
0060000809190251 D   mxseq#               10     11  0
0061000807310029  *
0062000807310250 D                 DS
0063000807310251 D  hldkey                 1     11  0 INZ(0)
0064000807310251 D  astrsk                12     22    INZ('***********')
0065000807310029  *
0066000809150250 D                 DS
0067000809150251 D  curact                 1    214
0068000811130251 D   mctrust               1      3  0
0069000809190251 D   mcsub                 4      6  0
0070000809190251 D   mcacct                7     10  0
0071000809190251 D   mcacnm               11     50
0072000711080029  *
0073000711080250 D                 DS
007400091002     D  recct                  1      6S 0
007500091002     D  reccta                 1      6
007600090108    * *
0077000901080053 D                 DS
0078000910020054 D  wkamt          S              9
0079000910130251 D  cntf           S              2  0 INZ(0)
0080000910130251 D  cntt           S              2  0 INZ(0)
0081000910130251 D  cntl           S              2  0 INZ(0)
0082000910130251 D  fnm1           S              1
0083000711080111  *
0084000910080029  *   Format Output Records
0085000910080250 D                 DS
0086000910160251 D  ibrec                  1    215
0087000910080251 D   ibrcid                1      2
0088000910080251 D   ibtpa                 3      8
0089000910080251 D   ibemlr                9     17
0090000910080251 D   ibemly               18     26
0091000910080251 D   iblnme               27     52
0092000910080251 D   ibfnme               53     71
0093000910080251 D   ibmi                 72     72
0094000910080251 D   ibphn#               73     91
0095000910080251 D   ibadr1               92    127
0096000910080251 D   ibadr2              128    163
0097000910080251 D   ibcity              164    183
0098000910080251 D   ibst                184    193
0099000910080251 D   ibzip               194    202
0100000910080251 D   ibcnty              203    205
0101000910080251 D   ibgndr              206    206
0102000910080251 D   ibbrdt              207    214
0103000910160251 D   ibrmth              215    215
0104000910080250 D                 DS
0105000910150251 D  icrec                  1    138
0106000910080251 D   icrcid                1      2
0107000910080251 D   ictpa                 3      8
0108000910080251 D   icemlr                9     17
0109000910150251 D   icplan               18     35
0110000912030251 D     pln12              18     29
0111000912030251 D     pln4               18     21
0112000912030251 D     pln3               22     24
0113000910150251 D   icemly               36     44
0114000910150251 D   icactp               45     48
0115000910150251 D   icpeff               49     56
0116000910150251 D   icptrm               57     64
0117000910150251 D   icsts                65     65
0118000910150251 D   iceypp               66     84
0119000910150251 D   icerpp               85    103
0120000910150251 D   icefrf              104    122
0121000910150251 D   icetrm              123    130
0122000910150251 D   iceeff              131    138
0123000910080250 D                 DS
0124001004150251 D  ifrec                  1     40
0125000910080251 D   ifrcid                1      2
0126000910080251 D   iftpa                 3      8
0127000910080251 D   ifemlr                9     17
0128000910080251 D   ifemly               18     26
0129001004150251 D   ifdep                27     37
0130001004150251 D   ifsmcd               38     38
0131001004150251 D   ifadcd               39     39
0132001004150251 D   ifissu               40     40
0133000910080250 D                 DS
0134000910080251 D  izrec                  1     42
0135000910080251 D   izrcid                1      2
0136000910080251 D   iztpa                 3      8
0137000910080251 D   izemlr                9     17
0138000910080251 D   izemly               18     26
0139000910080251 D   iztrm                27     34
0140000910080251 D   izelig               35     42
0141000910080291  *
014200080919     C     mbckey        klist
014300080919     C                   kfld                    mxmid#
014400080919     C                   kfld                    mxseq#
0145000508240291  *
0146001010280291  *   Preprocessing
0147001010280297 C                   movel     UDATE         today
0148001010280297 C                   movel     today         todayn
0149000803270291  *
0150000910020296 C                   dou       *in21 = '1'
0151001004220297 C                   read      mbchg2p                                21
0152001010110291  *
0153001010110296 C                   if        *in21 = '0'
0154001003120291  *
0155001010120296 C                   If        mxsts = 'C' and mxseq# = 0
0156000809260291  *
0157001010120296 C                   If        mxctfdt <> 0
0158001010270291  *      Skip AAAA and AAAQ grps - GBS
0159001010270296 C                   If        cgrp4 = 'AAAA' or cgrp4 = 'AAAQ'
0160001010270296 C                   iter
0161001010270296 C                   endif
0162000809260291  *      DEBUG
0163000910020296 C                   If        mxmid# = 212061187
0164000809260296 C                   movel     mxmid#        mxmid#
0165000910020291  *      Skip this SSN
0166000910020296 C                   iter
0167000910020296 C                   endif
016800080926      *
0169000807250296 C                   if        hldkey <> chgkey
0170000807250297 C                   eval      hldkey = chgkey
017100091001     C                   exsr      putnew
017200070605     C                   endif
017300080725     C                   else
017400091001      *
017500080725     C                   endif
017600080725     C                   endif
017700091002      *
017800101011     C                   endif
017900091002     C                   enddo
018000091002      *
018100091002     C                   eval      recct = recct + 1
018200091002     C                   movel     reccta        iarcnt
018300091002     C                   update    mbiar
018400091002      *
0185000910020297 C                   movel     '1'           *inlr
0186000910020297 C                   return
0187000705300107  ********************************************************************************
0188000705300107  *
0189000910010107  *     PUTNEW - Write the New record to MBI Import files
0190000705300107  *
0191000705300107  ********************************************************************************
019200091001     C     putnew        begsr
0193001004220297 C     mbckey        setll     mbcur2p                            21
0194000807250296 C                   dou       *in21 = '1'
0195001004220297 C                   read      mbcur2p                                21
0196000809190296 C                   If        *in21 = '0' and mcmid# = mxmid# and
0197000809190296 C                             mcseq# = mxseq#
0198000807250297 C                   leave
0199000807250297 C                   else
0200000706050297 C                   leavesr
0201000706050297 C                   endif
0202000706050297 C                   enddo
0203001010120291  *    IB rec ????
020400070530    * *
0205001010120291  *    IC Rec
020600101012     C                   If        grp1 = '*'
020700101012     C                   movel(P)  grp24         bgrp2
020800101012     C                   else
020900101012     C                   movel     grp4          bgrp2
021000101012     C                   endif
0211001010120291  *
021200091001     C                   movel(P)  mbgrp#        icemlr
021300091001     C                   movel     mcmid#        icemly
021400091001     C                   movel(P)  'HRA'         icactp
021500091203     C                   if        grp13 <> '   '
021600091204     C******?            movel(P)  grp13         pln3
021700100315     C                   movel(P)  grp13         icactp
021800091014     C                   endif
021900100315      *
022000100524     C                   if        grp1 = '*'
022100100524     C                   movel(P)  grp212        pln12
022200100524     C                   else
022300100524     C                   movel(P)  grp12         pln12
022400100524     C                   endif
022500100315     C                   if        pln3 = *blanks
022600100315     C                   movel(P)  'HRA'         pln3
022700100315     C                   endif
022800100315      *
022900100315     C                   movel     mcpefd        icpeff
023000100315     C                   movel     mcptrd        icptrm
023100091001     C                   move      '0.00'        iceypp
023200091001     C                   move      '0.00'        icerpp
023300091002     C                   eval      wkamt = %EDITW(mcrate:'      .  ')
023400091002     C                   move      wkamt         icefrf
023500091002     C                   if        mctfdt = 0
023600091002     C                   eval      icetrm = *blanks
023700091002     C                   else
023800101012     C                   movel     mxctfldt      icetrm
023900091002     C                   endif
024000101028    * *    Set sts to active for future term dates
024100101028     C                   if        mxctfldt > todayn
024200101028     C                   eval      icsts = '2'
024300101028     C                   else
024400101028     C                   eval      icsts = '5'
024500101028     C                   endif
024600101028    * *
024700091001     C                   movel     mcefdt        iceeff
024800091001    * *     Write IC rec
024900091001     C                   write     mbicr
025000091008     C                   clear                   mbcmbr
025100091008     C                   movel     icrec         mcdata
025200091008     C                   write     mbcmbr
025300091001     C                   eval      recct = recct + 1
025400091001    * *
0255001010120291  *     IF Rec ??
025600091001    * *
0257001010120291  *     IZ Rec ??
025800070530      *
025900070530     C                   endsr
0260000711080107  ********************************************************************************
0261000711080107  *
0262000910130107  *     NAMRTN - Reduce total Name length to 20 chars
0263000711080107  *
0264000711080107  ********************************************************************************
0265000910130296 C     namrtn        begsr
0266000910130296 C                   eval      cntl = %scan('  ':iblnme:2)
0267000910130296 C                   if        cntl = 0
0268000910130296 C                   eval      cntl = 25
0269000910130296 C                   else
0270000910130296 C                   eval      cntl = cntl - 1
0271000910130296 C                   endif
0272000910130291  *      If LNAM is GT 18 - Just use last name
0273000910130296 C                   if        cntl > 18
0274000910130296 C                   movel     *blanks       ibfnme
0275000910130296 C                   movel     *blanks       ibmi
0276000910130296 C                   leavesr
0277000910130296 C                   endif
0278000910130291  *
0279000910130296 C                   eval      cntf = %scan('  ':ibfnme:2)
0280000910130296 C                   if        cntf = 0
0281000910130296 C                   eval      cntf = 18
0282000910130296 C                   else
0283000910130296 C                   eval      cntf = cntf - 1
0284000910130296 C                   endif
0285000910130291  *   If LNAM + FNAM + 1 > 18 - remove MI
0286000910130296 C                   eval      cntt = cntl + cntf + 1
0287000910130296 C                   if        cntt > 18
0288000910130296 C                   eval      ibmi = ' '
0289000910130296 C                   endif
0290000910130291  *   If LNAM + FNAM + 1 > 20 - remove MI and use 1 char FNAM
0291000910130291  *
0292000910130296 C                   if        cntt > 20
0293000910130296 C                   movel     ibfnme        fnm1
0294000910130296 C                   movel(P)  fnm1          ibfnme
0295000910130296 C                   endif
0296000910130296 C                   endsr
0297000910130107  ********************************************************************************
0298000910130107  *
0299000910130107  *     INZSR - Preprocessing
0300000910130107  *
0301000910130107  ********************************************************************************
030200071108     C     *Inzsr        Begsr
030300091001    * *   SET DEFAULT FIELDS
0304001010120297 C****               clear                   mbibr
0305000910010297 C                   clear                   mbicr
0306001010120297 C*****              clear                   mbifr
0307001010120297 C*****              clear                   mbizr
0308001001150297 C                   eval      ibrcid = 'IB'
0309001001150297 C                   eval      icrcid = 'IC'
0310001001150297 C                   eval      ifrcid = 'IF'
0311001001150297 C                   eval      izrcid = 'IZ'
0312001001150297 C                   eval      ibtpa = 'T00025'
0313001001150297 C                   eval      ictpa = 'T00025'
0314001001150297 C                   eval      iftpa = 'T00025'
0315000910010297 C                   eval      iztpa = 'T00025'
031600091001    * *   Get IA rec
031700091001     C                   read      mbiap
0318000910010297 C                   eval      recct = 0
031900091001    * *
032000091001     C                   endsr
